name: EIA Weekly Inventories

on:
  schedule:
    # 07:00 BRT (UTC-3) = 10:00 UTC
    - cron: "0 10 * * Thu"
  workflow_dispatch:

jobs:
  run_eia_weekly:
    runs-on: ubuntu-latest

    env:
      EIA_API_KEY: ${{ secrets.EIA_API_KEY }}
      EIA_PETROLEUM_CRUDE_SERIES_ID: ${{ secrets.EIA_PETROLEUM_CRUDE_SERIES_ID }}
      EIA_PETROLEUM_PRODUCTS_SERIES_ID: ${{ secrets.EIA_PETROLEUM_PRODUCTS_SERIES_ID }}
      EIA_GAS_STORAGE_SERIES_ID: ${{ secrets.EIA_GAS_STORAGE_SERIES_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID_ENERGY: ${{ secrets.TELEGRAM_CHAT_ID_ENERGY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Fetch & parse EIA inventories
        run: |
          python scripts/energy/fetch_and_parse_eia.py

      - name: Smoke check
        run: |
          python scripts/energy/smoke_check_inventories.py \
            /tmp/petroleum_crude.csv \
            /tmp/petroleum_products.csv \
            /tmp/gas_storage.csv

      - name: Format individual Telegram messages (Crude / Products / Gas)
        run: |
          python scripts/energy/format_telegram_inventory.py \
            --crude /tmp/petroleum_crude.csv \
            --products /tmp/petroleum_products.csv \
            --gas /tmp/gas_storage.csv \
            --out-crude /tmp/telegram_petroleum_crude.txt \
            --out-products /tmp/telegram_petroleum_products.txt \
            --out-gas /tmp/telegram_gas_storage.txt

      - name: Format Energy Weekly Macro Summary
        run: |
          python scripts/energy/format_energy_weekly_summary.py \
            --crude /tmp/petroleum_crude.csv \
            --products /tmp/petroleum_products.csv \
            --gas /tmp/gas_storage.csv \
            --out /tmp/telegram_energy_summary.txt

      - name: Generate Energy charts (PNG)
        run: |
          python scripts/energy/plot_energy_charts.py \
            --crude /tmp/petroleum_crude.csv \
            --products /tmp/petroleum_products.csv \
            --gas /tmp/gas_storage.csv \
            --out-crude /tmp/crude_12w.png \
            --out-products /tmp/products_12w.png \
            --out-gas /tmp/gas_12w.png

      - name: Send messages and charts to Telegram
        run: |
          # Mensagens de texto
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id=${TELEGRAM_CHAT_ID_ENERGY} \
            -d parse_mode=Markdown \
            --data-urlencode "text@/tmp/telegram_petroleum_crude.txt"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id=${TELEGRAM_CHAT_ID_ENERGY} \
            -d parse_mode=Markdown \
            --data-urlencode "text@/tmp/telegram_petroleum_products.txt"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id=${TELEGRAM_CHAT_ID_ENERGY} \
            -d parse_mode=Markdown \
            --data-urlencode "text@/tmp/telegram_gas_storage.txt"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id=${TELEGRAM_CHAT_ID_ENERGY} \
            -d parse_mode=Markdown \
            --data-urlencode "text@/tmp/telegram_energy_summary.txt"

          # Gráficos (imagens)
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto" \
            -F chat_id=${TELEGRAM_CHAT_ID_ENERGY} \
            -F caption="Crude Inventories — últimas 12 semanas" \
            -F photo=@/tmp/crude_12w.png

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto" \
            -F chat_id=${TELEGRAM_CHAT_ID_ENERGY} \
            -F caption="Crude + Products — Total US — últimas 12 semanas" \
            -F photo=@/tmp/products_12w.png

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto" \
            -F chat_id=${TELEGRAM_CHAT_ID_ENERGY} \
            -F caption="Gas Storage — Lower 48 — últimas 12 semanas" \
            -F photo=@/tmp/gas_12w.png
