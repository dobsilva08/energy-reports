name: EIA Weekly Inventories

on:
  schedule:
    - cron: "0 12 * * Thu"
  workflow_dispatch:

jobs:
  run_eia_weekly:
    runs-on: ubuntu-latest

    env:
      EIA_API_KEY: ${{ secrets.EIA_API_KEY }}
      EIA_PETROLEUM_CRUDE_SERIES_ID: ${{ secrets.EIA_PETROLEUM_CRUDE_SERIES_ID }}
      EIA_PETROLEUM_PRODUCTS_SERIES_ID: ${{ secrets.EIA_PETROLEUM_PRODUCTS_SERIES_ID }}
      EIA_GAS_STORAGE_SERIES_ID: ${{ secrets.EIA_GAS_STORAGE_SERIES_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID_ENERGY: ${{ secrets.TELEGRAM_CHAT_ID_ENERGY }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Fetch & parse EIA inventories
        run: python scripts/energy/fetch_and_parse_eia.py

      - name: Smoke check
        run: |
          python scripts/energy/smoke_check_inventories.py \
            /tmp/petroleum_crude.csv \
            /tmp/petroleum_products.csv \
            /tmp/gas_storage.csv

      - name: Format Telegram messages
        run: |
          python scripts/energy/format_telegram_inventory.py \
            --crude /tmp/petroleum_crude.csv \
            --products /tmp/petroleum_products.csv \
            --gas /tmp/gas_storage.csv \
            --out-crude /tmp/telegram_petroleum_crude.txt \
            --out-products /tmp/telegram_petroleum_products.txt \
            --out-gas /tmp/telegram_gas_storage.txt

      - name: Send messages to Telegram
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id=${TELEGRAM_CHAT_ID_ENERGY} \
            -d parse_mode=Markdown \
            --data-urlencode "text@/tmp/telegram_petroleum_crude.txt"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id=${TELEGRAM_CHAT_ID_ENERGY} \
            -d parse_mode=Markdown \
            --data-urlencode "text@/tmp/telegram_petroleum_products.txt"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id=${TELEGRAM_CHAT_ID_ENERGY} \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "text@/tmp/telegram_gas_storage.txt"
